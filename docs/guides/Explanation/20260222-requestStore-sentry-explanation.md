# API ì„œë²„ì˜ ë¡œê¹…/ì—ëŸ¬ ì²˜ë¦¬ ì›ë¦¬ ë° Sentry ì„±ëŠ¥ ì¸¡ì •(Performance) ë¹„êµ ë¶„ì„ ë³´ê³ ì„œ

ì§ˆë¬¸í•´ì£¼ì‹  ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ í˜„ì¬ GraphNode í”„ë¡œì íŠ¸ì—ì„œ **(1) `requestStore`ì™€ `asyncHandler`ì˜ ì—­í•  ë¹„êµ ë° API ìš”ì²­ íë¦„**, ê·¸ë¦¬ê³  **(2) Sentry ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§(`startSpan`)ì´ API ì„œë²„ì— ì–´ë–»ê²Œ êµ¬í˜„ë˜ì–´ ìˆëŠ”ì§€** ìƒì„¸íˆ ì„¤ëª…í•´ ë“œë¦½ë‹ˆë‹¤.

---

## ğŸ“Œ 1. `requestStore.run` ê³¼ `asyncHandler` ì˜ ì°¨ì´ ë° API ì„œë²„ ë™ì‘ ì›ë¦¬

ê²°ë¡ ë¶€í„° ë§ì”€ë“œë¦¬ë©´, ì§ˆë¬¸í•˜ì‹  ë‚´ìš©ì´ ì •í™•íˆ ë§ìŠµë‹ˆë‹¤. 
Workerì—ì„œ `requestStore.run`ì„ í†µí•´ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì£¼ì…í•´ì¤€ ê²ƒë§Œìœ¼ë¡œë„, **"Worker ì—­ì‹œ API ì„œë²„ì™€ 100% ë™ì¼í•œ í™˜ê²½ì„ ê°€ì§„ ê²ƒì²˜ëŸ¼ ì·¨ê¸‰ë˜ì–´, ë‚´ë¶€ì˜ ëª¨ë“  Service ë¡œì§ì´ ë™ì¼í•œ ë¡œê¹…(auditProxy) í˜œíƒì„ ë°›ê²Œ ë©ë‹ˆë‹¤."**

ê·¸ë ‡ë‹¤ë©´ API ì„œë²„ì˜ ë¼ìš°í„° ì½”ë“œì— ì”Œì›Œì ¸ ìˆëŠ” `asyncHandler`ëŠ” ì™œ í•„ìš”í•œ ê²ƒì¸ì§€, ê°ê°ì˜ ì—­í• ê³¼ ë™ì‘ íë¦„ì„ ë¶„ë¦¬í•´ì„œ ì´í•´í•´ì•¼ í•©ë‹ˆë‹¤.

### A. `requestStore`ì˜ ì˜ë¯¸ì™€ ì›ë¦¬ (Context ì£¼ì…)
- **ì›ë¦¬:** Node.jsì˜ `AsyncLocalStorage`ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ëŠ” ë§ˆì¹˜ Javaì˜ `ThreadLocal`ê³¼ ê°™ì´, **ë¹„ë™ê¸° íë¦„ì´ ì´ì–´ì§€ëŠ” ë™ì•ˆ ë³´ì´ì§€ ì•ŠëŠ” ê°€ìƒì˜ "ì„œë"**ì„ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.
- **ì—­í• :** API ì„œë²„ì— ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ ìµœìƒë‹¨ ë¯¸ë“¤ì›¨ì–´(`requestContext` ë¯¸ë“¤ì›¨ì–´)ì—ì„œ í—¤ë”ë¥¼ ê²€ì‚¬í•´ ìš”ì²­ ID(`correlationId`)ì™€ ìœ ì € ID(`userId`)ë¥¼ ì´ ê°€ìƒì˜ ì„œëì— ë„£ìŠµë‹ˆë‹¤(`requestStore.run`).
- **íš¨ê³¼:** ì´ë ‡ê²Œ í•´ë‘ë©´, ì € ê¹Šì€ ê³³ì— ìˆëŠ” `Service`ë‚˜ `Repository` í•¨ìˆ˜ë“¤ ë‚´ë¶€ì—ì„œ êµ³ì´ íŒŒë¼ë¯¸í„°ë¡œ `userId`ë‚˜ `taskId`ë¥¼ ë„˜ê²¨ë°›ì§€ ì•Šì•„ë„, `auditProxy`ê°€ ì•Œì•„ì„œ ì´ ê°€ìƒì˜ ì„œë(`requestStore.getStore()`)ì„ ì—´ì–´ í˜„ì¬ ì‘ì—…ì˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì™€ `logger.info`ë¡œ í‘œì¤€í™”ëœ ë¡œê·¸ë¥¼ ë‚¨ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. API ì„œë²„ë“  Workerë“  ìƒê´€ì—†ì´ ì´ ì„œëì— ê°’ì„ ë„£ì–´ì£¼ê³  ì‹¤í–‰ì‹œí‚¤ëŠ” í–‰ìœ„(`requestStore.run`)ë§Œ í•´ì£¼ë©´ ëª¨ë“  ë¡œê¹…ì´ ì™„ì„±ë©ë‹ˆë‹¤.

### B. `asyncHandler`ì˜ ì˜ë¯¸ì™€ ì›ë¦¬ (Express ì—ëŸ¬ ìºì¹­)
- **ì›ë¦¬:** `Promise.resolve(fn(req, res, next)).catch(next);` ë¡œ êµ¬ì„±ëœ ì•„ì£¼ ë‹¨ìˆœí•œ í•¨ìˆ˜ ë˜í¼ì…ë‹ˆë‹¤.
- **ì—­í• :** ì´ í•¨ìˆ˜ëŠ” ë¡œê¹…(Log)ì´ë‚˜ ì»¨í…ìŠ¤íŠ¸(Context)ì™€ëŠ” **ì•„ë¬´ëŸ° ìƒê´€ì´ ì—†ìŠµë‹ˆë‹¤.**
- **ì™œ í•„ìš”í•œê°€?** Express 4.x í”„ë ˆì„ì›Œí¬ëŠ” ë¼ìš°í„° ë‚´ë¶€ì—ì„œ `async` í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ë‹¤ê°€ ì—ëŸ¬(Promise Rejection)ê°€ ë‚˜ë©´, ì´ë¥¼ ìë™ìœ¼ë¡œ ì¡ì•„ì±„ì§€ ëª»í•˜ê³  ì„œë²„ë¥¼ ë»—ê²Œ í•˜ê±°ë‚˜ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì‘ë‹µì„ ì£¼ì§€ ì•Šê³  ë¬´í•œ ëŒ€ê¸°ë¥¼ ì‹œí‚¤ëŠ” ì¹˜ëª…ì ì¸ ì•½ì ì´ ìˆìŠµë‹ˆë‹¤.
- **íš¨ê³¼:** `asyncHandler`ë¡œ ë¼ìš°í„° í•¨ìˆ˜ ì „ì²´ë¥¼ ê°ì‹¸ì£¼ë©´, ë‚´ë¶€ì˜ Service/DB ìš”ì²­ ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆì„ ë•Œ ì´ ì—ëŸ¬ë¥¼ ì•ˆì „í•˜ê²Œ ë‚šì•„ì±„ì–´(catch) Expressì˜ ê¸€ë¡œë²Œ ì—ëŸ¬ í•¸ë“¤ëŸ¬(`errorHandler`)ë¡œ ë„˜ê²¨ì¤ë‹ˆë‹¤. ì´ ê¸€ë¡œë²Œ ì—ëŸ¬ í•¸ë“¤ëŸ¬ê°€ ì‚¬ìš©ìì—ê²Œ í‘œì¤€ í¬ë§·(`Problem Details`)ìœ¼ë¡œ HTTP 500 ì‘ë‹µì„ ë‚´ë³´ë‚´ê³  Sentryì— ì—ëŸ¬ë¥¼ ë³´ê³ í•©ë‹ˆë‹¤.
- **Workerì— ì—†ëŠ” ì´ìœ :** WorkerëŠ” Express(ì›¹ ë¼ìš°í„°) í†µì‹ ì„ í•˜ì§€ ì•Šê³  `sqs-consumer` ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í†µí•´ ìì²´ì ìœ¼ë¡œ íë¥¼ ê°€ì ¸ì™€ `try...catch`ë¡œ ì²˜ë¦¬í•˜ê¸° ë•Œë¬¸ì— `asyncHandler`ë¼ëŠ” ë¯¸ë“¤ì›¨ì–´ ë³´ì¡° ë„êµ¬ê°€ í•„ìš” ì—†ëŠ” ê²ƒì…ë‹ˆë‹¤.

### ğŸ”„ API ì„œë²„ ìš”ì²­ ë™ì‘ íë¦„ (ì •ë¦¬)
1. **HTTP ìš”ì²­ ì¸ì…** (ex: `POST /v1/ai/chat`)
2. => **`requestContext` ë¯¸ë“¤ì›¨ì–´ ì‹¤í–‰:** í—¤ë” íŒŒì‹± í›„ `requestStore.run`ì„ í˜¸ì¶œí•˜ì—¬ ê°€ìƒì˜ ì„œëì— Trace ID ë“± ì£¼ì… (ì´ì œë¶€í„° ë¡œê¹… ë§¥ë½ ì—°ê²°!)
3. => **`asyncHandler` í†µê³¼:** í˜¹ì‹œë¼ë„ ë’¤ì—ì„œ ì—ëŸ¬ê°€ ë‚˜ë©´ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•  ì¤€ë¹„
4. => **Controller ë¡œì§ ì‹¤í–‰:**
5. => **Service ì ‘ê·¼ (`auditProxy` í†µê³¼):** ë©”ì„œë“œ ì‹œì‘(`audit.call`), ì†Œìš”ì‹œê°„/ì„±ëŠ¥/ê²°ê³¼ ê¸°ë¡(`audit.success` ë˜ëŠ” `audit.error`)
6. => **ì‘ë‹µ ë°˜í™˜** (ì‹¤íŒ¨ ì‹œ `asyncHandler`ê°€ ìºì¹˜í•´ì„œ Global Error Handlerì—ì„œ `Problem Details` ì–‘ì‹ ë°˜í™˜)

---

## ğŸ“Œ 2. Sentry ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ (`startSpan` / Performance) API ì„œë²„ ì—¬ë¶€ ì¡°ì‚¬

Worker ì½”ë“œì— ìˆ˜ë™ìœ¼ë¡œ ë‹¬ì•„ì¤€ `Sentry.startSpan({ op: 'queue.process' })` ì™€ ê°™ì€ ì½”ë“œê°€ API ì„œë²„ì—ë„ êµ¬í˜„ë˜ì–´ ìˆì„ê¹Œìš”?

### ê²°ê³¼: **API ì„œë²„ëŠ” ì´ë¯¸ ìë™ìœ¼ë¡œ ì™„ë²½í•˜ê²Œ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.**

- ì¡°ì‚¬ë¥¼ ìœ„í•´ `src/index.ts`, `src/bootstrap/server.ts`, `src/shared/utils/sentry.ts` ì „ì²´ë¥¼ ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤. íŠ¹ì • ë¡œì§ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ `startSpan`ì„ í˜¸ì¶œí•˜ëŠ” ì½”ë“œëŠ” ì¼ì ˆ ì—†ì—ˆìŠµë‹ˆë‹¤.
- **ê·¸ëŸ°ë° ì–´ë–»ê²Œ ì‘ë™í• ê¹Œìš”?**
  `src/shared/utils/sentry.ts`ì˜ ì´ˆê¸°í™” ë¡œì§ì— ë‹¤ìŒ ì½”ë“œê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
  ```typescript
  Sentry.init({
    // ...
    integrations: [
      Sentry.httpIntegration(),
      Sentry.expressIntegration(), // <--- í•µì‹¬
      nodeProfilingIntegration(),
    ],
    tracesSampleRate: 1.0, 
  });
  ```
- **ìë™ ì¶”ì (Auto-Instrumentation):** `Sentry.expressIntegration()` í”ŒëŸ¬ê·¸ì¸ì´ Express ì•±ê³¼ ì™„ë²½í•˜ê²Œ ê²°í•©í•˜ì—¬, **ë“¤ì–´ì˜¤ëŠ” ëª¨ë“  HTTP ìš”ì²­ì— ëŒ€í•´ ìë™ìœ¼ë¡œ `IsolationScope`ë¥¼ ë§Œë“¤ê³ , ìë™ìœ¼ë¡œ ë¼ìš°íŠ¸ ì—”ë“œí¬ì¸íŠ¸(`GET /v1/ai`) ë‹¨ìœ„ë¡œ Performance Spanì„ ìƒì„±**í•˜ì—¬ ì‘ë‹µí•  ë•Œê¹Œì§€ì˜ ì†Œìš” ì‹œê°„ì„ ì•Œì•„ì„œ ì¬ê³  Sentryë¡œ ì „ì†¡í•©ë‹ˆë‹¤. 
- API ì„œë²„ëŠ” ì´ í”ŒëŸ¬ê·¸ì¸ì˜ ê°•ë ¥í•œ ê¸°ëŠ¥ ë•ë¶„ì— ì¼ì¼ì´ ë¼ìš°í„° í•¨ìˆ˜ë§ˆë‹¤ `startSpan`ì„ ë‹¬ì•„ì¤„ í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. 

### Workerì—ë§Œ ìˆ˜ë™ìœ¼ë¡œ êµ¬í˜„í•œ ì´ìœ 
WorkerëŠ” Express HTTP ì„œë²„ê°€ ì•„ë‹™ë‹ˆë‹¤. SQS ë©”ì‹œì§€ í´ë§ê¸°(`sqs-consumer`)ëŠ” Sentry ê³µì‹ ì§€ì› í†µí•©(Integration) ëª¨ë“ˆì´ ì—†ê¸° ë•Œë¬¸ì—, Sentry ì…ì¥ì—ì„œëŠ” "ì´ í”„ë¡œì„¸ìŠ¤ê°€ ì§€ê¸ˆ íë¥¼ ê°€ì ¸ì™€ì„œ ëª‡ ì´ˆ ë™ì•ˆ ì–´ë–¤ ì‘ì—…ì„ í•˜ê³  ìˆëŠ” ì§€" ì•Œ í„±ì´ ì—†ìŠµë‹ˆë‹¤. 
ë”°ë¼ì„œ API ì„œë²„ê°€ ìë™ í”ŒëŸ¬ê·¸ì¸(`expressIntegration()`)ì„ í†µí•´ ê³µì§œë¡œ ì–»ëŠ” ê¸°ëŠ¥ì„, **Worker í™˜ê²½ì—ì„œëŠ” `Sentry.withIsolationScope`ì™€ `startSpan`ì„ í†µí•´ ìˆ˜ë™ìœ¼ë¡œ ë˜‘ê°™ì´ êµ¬í˜„í•´ ì¤€ ê²ƒ**ì…ë‹ˆë‹¤.

### ê²°ë¡  ë° ì œì–¸
í˜„ì¬ API ì„œë²„ëŠ” **ì–´ë–¤ ì¶”ê°€ ì‘ì—…ì´ë‚˜ `asyncHandler` ë¶€ë¶„ì˜ ìˆ˜ì •ì´ í•„ìš” ì—†ì´**, ì´ë¯¸ Sentry Performance ì¸¡ì •(Traces)ì´ ì™„ë²½í•˜ê²Œ ë™ì‘í•˜ëŠ” ìƒíƒœì…ë‹ˆë‹¤. `Sentry`ì˜ `Performance` ëŒ€ì‹œë³´ë“œì— ë“¤ì–´ê°€ì‹œë©´, API ì„œë²„(`http.server` ë“±)ì˜ ì—”ë“œí¬ì¸íŠ¸ ì‘ë‹µ ì‹œê°„ê³¼, ì´ë²ˆì— ì¶”ê°€í•œ SQS Worker(`queue.process`) ì‘ì—… ì†Œìš” ì‹œê°„ì´ ì™„ë²½íˆ ë¶„ë¦¬ë˜ì–´ ì•„ì£¼ ì˜ˆì˜ê²Œ ì¸¡ì •ë˜ê³  ìˆëŠ” ê²ƒì„ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
