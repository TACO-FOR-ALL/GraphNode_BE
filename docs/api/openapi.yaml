openapi: 3.1.0
info:
  title: GraphNode API
  version: 0.1.0
  description: >-
    Backend API for GraphNode. Errors follow RFC 9457 Problem Details.
jsonSchemaDialect: https://json-schema.org/draft/2020-12/schema
paths:
  /healthz:
    get:
      summary: Health check
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                required: [ok]
              example:
                $ref: './examples/health-ok.json'
        '404':
          description: Not Found
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
              example:
                $ref: './examples/problem-404.json'
  /v1/healthz:
    get:
      summary: Health check (versioned)
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                required: [ok]
              example:
                $ref: './examples/health-ok.json'
        '404':
          description: Not Found
          content:
            application/problem+json:
              schema:
                $ref: '../schemas/problem.json'
              example:
                $ref: './examples/problem-404.json'
  /v1/microscope:
    get:
      summary: List all user workspaces
      tags: [Microscope]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '../schemas/microscope.json'
        '401':
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: '../schemas/problem.json'
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: '../schemas/problem.json'
    post:
      summary: Create new workspace and upload documents
      tags: [Microscope]
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                name:
                  type: string
                schemaName:
                  type: string
                files:
                  type: array
                  items:
                    type: string
                    format: binary
              required: [name]
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '../schemas/microscope.json'
        '400':
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: '../schemas/problem.json'
        '401':
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: '../schemas/problem.json'
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: '../schemas/problem.json'
  /v1/microscope/{groupId}:
    get:
      summary: Get detailed workspace status
      tags: [Microscope]
      parameters:
        - name: groupId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '../schemas/microscope.json'
        '401':
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: '../schemas/problem.json'
        '404':
          description: Not Found
          content:
            application/problem+json:
              schema:
                $ref: '../schemas/problem.json'
    delete:
      summary: Delete workspace and associated graph
      tags: [Microscope]
      parameters:
        - name: groupId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: No Content
        '401':
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: '../schemas/problem.json'
        '404':
          description: Not Found
          content:
            application/problem+json:
              schema:
                $ref: '../schemas/problem.json'
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: '../schemas/problem.json'
  /v1/microscope/{groupId}/documents:
    post:
      summary: Add more documents to existing workspace
      tags: [Microscope]
      parameters:
        - name: groupId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                schemaName:
                  type: string
                files:
                  type: array
                  items:
                    type: string
                    format: binary
              required: [files]
      responses:
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: '../schemas/problem.json'
        '401':
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: '../schemas/problem.json'
        '404':
          description: Not Found
          content:
            application/problem+json:
              schema:
                $ref: '../schemas/problem.json'
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: '../schemas/problem.json'
  /auth/google/start:
    get:
      summary: Start Google OAuth (redirects)
      description: Initiates Google OAuth2 authorization with state and PKCE. Redirects to Google's consent screen.
      responses:
        '302':
          description: Redirects to Google authorization URL
  /auth/google/callback:
    get:
      summary: Google OAuth callback
      description: Handles Google OAuth2 authorization code exchange. On success, sets a session cookie and returns ok.
      parameters:
        - in: query
          name: code
          required: true
          schema:
            type: string
        - in: query
          name: state
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Login succeeded, session cookie set
          headers:
            Set-Cookie:
              description: Session cookie set by server
              schema:
                type: string
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                required: [ok]
              example:
                $ref: './examples/oauth-login-ok.json'
        '400':
          description: Bad Request (missing/invalid parameters or state mismatch)
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
              example:
                $ref: './examples/problem-400.json'
        '502':
          description: Upstream error (provider failure)
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
              example:
                $ref: './examples/problem-502.json'
  /v1/notifications/stream:
    get:
      summary: Connect to notification stream (SSE)
      description: Establishes a Server-Sent Events (SSE) connection to receive real-time notifications.
      responses:
        '200':
          description: Stream established
          content:
            text/event-stream:
              schema:
                type: string
                example: |
                  data: {"type":"CONNECTED","message":"SSE Connection established"}

                  data: {"type":"JOB_COMPLETED","payload":{...}}
  /v1/notifications/device-token:
    post:
      summary: Register FCM device token
      description: Registers a Firebase Cloud Messaging (FCM) token for the authenticated user.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token]
              properties:
                token:
                  type: string
                  description: The FCM device token to register.
      responses:
        '200':
          description: Token registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
        '400':
          description: Bad Request (missing token)
        '401':
          description: Not authenticated
    delete:
      summary: Unregister FCM device token
      description: Removes a Firebase Cloud Messaging (FCM) token for the authenticated user (e.g., on logout).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token]
              properties:
                token:
                  type: string
                  description: The FCM device token to unregister.
      responses:
        '200':
          description: Token unregistered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
        '400':
          description: Bad Request (missing token)
        '401':
          description: Not authenticated
  /v1/me:
    get:
      summary: Check login status
      description: Returns current user if session cookie (server session) exists.
      responses:
        '200':
          description: Authenticated
          content:
            application/json:
              schema:
                $ref: ../schemas/me-response.json
              example:
                $ref: './examples/me-get-200.json'
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
              example:
                $ref: './examples/me-get-401.json'
  /v1/ai/conversations/bulk:
    post:
      summary: Bulk create conversations
      description: Creates multiple conversations and their associated messages in a single request.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                conversations:
                  type: array
                  items:
                    $ref: ../schemas/conversation.json
            examples:
              default:
                $ref: ./examples/ai-conversations-bulk-post-request.json
      responses:
        '201':
          description: Bulk creation successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  conversations:
                    type: array
                    items:
                      $ref: ../schemas/conversation.json
              examples:
                default:
                  $ref: ./examples/ai-conversations-bulk-post-201.json
        '400':
          description: Bad Request (e.g., validation error)
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
              example:
                $ref: './examples/problem-400.json'
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
              example:
                $ref: './examples/me-get-401.json'
  /v1/ai/conversations:
    post:
      summary: Create conversation
      description: Creates a new conversation using client-provided UUID/ULID as id. Optionally accepts initial messages.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id, title]
              properties:
                id: { type: string }
                title: { type: string }
                messages:
                  type: array
                  items: { $ref: ../schemas/message.json }
            examples:
              default:
                externalValue: ./examples/ai-conversation-create-request.json
      responses:
        '201':
          description: Created
          headers:
            Location:
              description: Resource URL of the created conversation
              schema: { type: string }
          content:
            application/json:
              schema: { $ref: ../schemas/conversation.json }
              examples:
                default:
                  externalValue: ./examples/ai-conversation-create-201.json
        '400':
          description: Bad Request
          content:
            application/problem+json:
              schema: { $ref: ../schemas/problem.json }
    get:
      summary: List conversations
      parameters:
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 100, default: 50 }
        - in: query
          name: cursor
          schema: { type: string, description: ISO 8601 cursor }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: ../schemas/conversation.json }
                  nextCursor:
                    oneOf:
                      - { type: string }
                      - { type: 'null' }
              examples:
                default:
                  externalValue: ./examples/ai-conversation-list-200.json
    delete:
      summary: Delete all conversations
      description: Deletes all conversations and messages for the authenticated user.
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  deletedCount:
                    type: integer
  /v1/ai/conversations/{conversationId}:
    get:
      summary: Get conversation
      parameters:
        - in: path
          name: conversationId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: ../schemas/conversation.json }
              examples:
                default:
                  externalValue: ./examples/ai-conversation-get-200.json
        '404':
          description: Not Found
          content:
            application/problem+json:
              schema: { $ref: ../schemas/problem.json }
    patch:
      summary: Update conversation
      parameters:
        - in: path
          name: conversationId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title: { type: string }
            examples:
              default:
                externalValue: ./examples/ai-conversation-update-request.json
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: ../schemas/conversation.json }
              examples:
                default:
                  externalValue: ./examples/ai-conversation-update-200.json
    delete:
      summary: Delete conversation
      parameters:
        - in: path
          name: conversationId
          required: true
          schema: { type: string }
        - in: query
          name: permanent
          schema: { type: boolean, default: false }
          description: If true, performs a hard delete. Otherwise, soft delete.
      responses:
        '204':
          description: No Content
  /v1/ai/conversations/{conversationId}/restore:
    post:
      summary: Restore a deleted conversation
      parameters:
        - in: path
          name: conversationId
          required: true
          schema: { type: string }
      responses:
        '204':
          description: Conversation restored
        '404':
          description: Conversation not found
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
  /v1/ai/conversations/{conversationId}/messages:
    post:
      summary: Create message
      parameters:
        - in: path
          name: conversationId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: ../schemas/message.json
            examples:
              default:
                externalValue: ./examples/ai-message-create-request.json
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema: { $ref: ../schemas/message.json }
              examples:
                default:
                  externalValue: ./examples/ai-message-create-201.json
  /v1/ai/conversations/{conversationId}/messages/{messageId}:
    patch:
      summary: Update message
      parameters:
        - in: path
          name: conversationId
          required: true
          schema: { type: string }
        - in: path
          name: messageId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                role: { type: string, enum: [user, assistant, system] }
                content: { type: string }
            examples:
              default:
                externalValue: ./examples/ai-message-update-request.json
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: ../schemas/message.json }
              examples:
                default:
                  externalValue: ./examples/ai-message-update-200.json
    delete:
      summary: Delete message
      parameters:
        - in: path
          name: conversationId
          required: true
          schema: { type: string }
        - in: path
          name: messageId
          required: true
          schema: { type: string }
        - in: query
          name: permanent
          schema: { type: boolean, default: false }
          description: If true, performs a hard delete. Otherwise, soft delete.
      responses:
        '204':
          description: No Content
  /v1/ai/conversations/{conversationId}/messages/{messageId}/restore:
    post:
      summary: Restore a deleted message
      parameters:
        - in: path
          name: conversationId
          required: true
          schema: { type: string }
        - in: path
          name: messageId
          required: true
          schema: { type: string }
      responses:
        '204':
          description: Message restored
        '404':
          description: Message not found
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
  /v1/ai/conversations/{conversationId}/chat:
    post:
      summary: Send message to AI (Chat)
      description: Sends a user message to the AI model. Supports file uploads for multimodal models (e.g., OpenAI Assistants, GPT-4o).
      parameters:
        - in: path
          name: conversationId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [model, chatContent]
              properties:
                id: { type: string, format: uuid }
                model:
                  type: string
                  enum: [openai, claude, gemini, deepseek]
                chatContent: { type: string }
                files:
                  type: array
                  items: { type: string, format: binary }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  title: { type: string }
                  messages:
                    type: array
                    items: { $ref: ../schemas/message.json }
        '400':
          description: Bad Request
          content:
            application/problem+json:
              schema: { $ref: ../schemas/problem.json }
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema: { $ref: ../schemas/problem.json }
        '502':
          description: Upstream error (AI provider failure)
          content:
            application/problem+json:
              schema: { $ref: '../schemas/problem.json' }
  /v1/ai/files:
    post:
      summary: Upload files
      description: Uploads files for AI consumption or attachments (like images or documents).
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [files]
              properties:
                files:
                  type: array
                  items:
                    type: string
                    format: binary
      responses:
        '201':
          description: Upload successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  attachments:
                    type: array
                    items:
                      type: object
                      properties:
                        id: { type: string }
                        type: { type: string }
                        url: { type: string }
                        name: { type: string }
                        mimeType: { type: string }
                        size: { type: number }
        '400':
          description: Bad Request
          content:
            application/problem+json:
              schema: { $ref: '../schemas/problem.json' }
  /v1/ai/files/{key}:
    get:
      summary: Download AI file
      description: Downloads a file generated or uploaded during AI chat interactions.
      parameters:
        - in: path
          name: key
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/octet-stream:
              schema: { type: string, format: binary }
        '404':
          description: File not found
          content:
            application/problem+json:
              schema: { $ref: ../schemas/problem.json }
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema: { $ref: ../schemas/problem.json }
  /auth/logout:
    post:
      summary: Logout and destroy session
      responses:
        '204':
          description: Session destroyed
          headers:
            Set-Cookie:
              description: Session cookie cleared (Max-Age=0)
              schema:
                type: string
        '401':
          description: Not authenticated (if already logged out, implementation may still return 204)
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
  /v1/graph/nodes:
    post:
      summary: Create or update a graph node
      description: Inserts a new node or updates an existing one based on its ID.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: ../schemas/graph-node.json
      responses:
        '201':
          description: Node created/updated successfully.
          content:
            application/json:
              schema:
                $ref: ../schemas/graph-node.json
              examples:
                default:
                  $ref: '#/components/examples/graphNodeCreate201'
        '400':
          description: Bad Request (validation error).
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
    get:
      summary: List all graph nodes for the user
      description: Retrieves a list of all graph nodes associated with the authenticated user.
      responses:
        '200':
          description: A list of graph nodes.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: ../schemas/graph-node.json
              examples:
                default:
                  $ref: '#/components/examples/graphNodeList200'
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
  /v1/graph/nodes/{nodeId}:
    get:
      summary: Get a specific graph node
      parameters:
        - name: nodeId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: The requested graph node.
          content:
            application/json:
              schema:
                $ref: ../schemas/graph-node.json
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
        '404':
          description: Node not found.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
    patch:
      summary: Update a graph node
      parameters:
        - name: nodeId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                clusterId: { type: string }
                clusterName: { type: string }
      responses:
        '204':
          description: Node updated successfully.
        '400':
          description: Bad Request.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
        '404':
          description: Node not found.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
    delete:
      summary: Delete a graph node
      parameters:
        - name: nodeId
          in: path
          required: true
          schema:
            type: integer
        - in: query
          name: permanent
          schema: { type: boolean, default: false }
          description: If true, performs a hard delete. Otherwise, soft delete.
      responses:
        '204':
          description: Node deleted successfully.
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
  /v1/graph/nodes/{nodeId}/restore:
    post:
      summary: Restore a deleted graph node
      parameters:
        - name: nodeId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Node restored successfully.
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
  /v1/graph/nodes/{nodeId}/cascade:
    delete:
      summary: Delete a graph node and its connected edges
      parameters:
        - name: nodeId
          in: path
          required: true
          schema:
            type: integer
        - in: query
          name: permanent
          schema: { type: boolean, default: false }
          description: If true, performs a hard delete. Otherwise, soft delete.
      responses:
        '204':
          description: Node and edges deleted successfully.
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
  /v1/graph/edges:
    post:
      summary: Create or update a graph edge
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: ../schemas/graph-edge.json
      responses:
        '201':
          description: Edge created/updated successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
              examples:
                default:
                  $ref: '#/components/examples/graphEdgeCreate201'
        '400':
          description: Bad Request.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
    get:
      summary: List all graph edges for the user
      responses:
        '200':
          description: A list of graph edges.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: ../schemas/graph-edge.json
              examples:
                default:
                  $ref: '#/components/examples/graphEdgeList200'
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
  /v1/graph/edges/{edgeId}:
    delete:
      summary: Delete a graph edge
      parameters:
        - name: edgeId
          in: path
          required: true
          schema:
            type: string
        - in: query
          name: permanent
          schema: { type: boolean, default: false }
          description: If true, performs a hard delete. Otherwise, soft delete.
      responses:
        '204':
          description: Edge deleted successfully.
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
  /v1/graph/edges/{edgeId}/restore:
    post:
      summary: Restore a deleted graph edge
      parameters:
        - name: edgeId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Edge restored successfully.
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
  /v1/graph/clusters:
    post:
      summary: Create or update a graph cluster
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: ../schemas/graph-cluster.json
      responses:
        '201':
          description: Cluster created/updated successfully.
          content:
            application/json:
              schema:
                $ref: ../schemas/graph-cluster.json
              examples:
                default:
                  $ref: '#/components/examples/graphClusterCreate201'
        '400':
          description: Bad Request.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
    get:
      summary: List all graph clusters for the user
      responses:
        '200':
          description: A list of graph clusters.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: ../schemas/graph-cluster.json
              examples:
                default:
                  $ref: '#/components/examples/graphClusterList200'
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
  /v1/graph/clusters/{clusterId}:
    get:
      summary: Get a specific graph cluster
      parameters:
        - name: clusterId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: The requested graph cluster.
          content:
            application/json:
              schema:
                $ref: ../schemas/graph-cluster.json
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
        '404':
          description: Cluster not found.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
    delete:
      summary: Delete a graph cluster
      parameters:
        - name: clusterId
          in: path
          required: true
          schema:
            type: string
        - in: query
          name: permanent
          schema: { type: boolean, default: false }
          description: If true, performs a hard delete. Otherwise, soft delete.
      responses:
        '204':
          description: Cluster deleted successfully.
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
  /v1/graph/clusters/{clusterId}/restore:
    post:
      summary: Restore a deleted graph cluster
      parameters:
        - name: clusterId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Cluster restored successfully.
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
  /v1/graph/subclusters:
    post:
      summary: Create or update a graph subcluster
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: ../schemas/graph-subcluster.json
      responses:
        '201':
          description: Subcluster created/updated successfully.
          content:
            application/json:
              schema:
                $ref: ../schemas/graph-subcluster.json
        '400':
          description: Bad Request.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
    get:
      summary: List all graph subclusters for the user
      responses:
        '200':
          description: A list of graph subclusters.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: ../schemas/graph-subcluster.json
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
  /v1/graph/subclusters/{subclusterId}:
    get:
      summary: Get a specific graph subcluster
      parameters:
        - name: subclusterId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: The requested graph subcluster.
          content:
            application/json:
              schema:
                $ref: ../schemas/graph-subcluster.json
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
        '404':
          description: Subcluster not found.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
    delete:
      summary: Delete a graph subcluster
      parameters:
        - name: subclusterId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Subcluster deleted successfully.
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json

  /v1/graph/clusters/{clusterId}/cascade:
    delete:
      summary: Delete a cluster and its contained nodes and edges
      parameters:
        - name: clusterId
          in: path
          required: true
          schema:
            type: string
        - in: query
          name: permanent
          schema: { type: boolean, default: false }
          description: If true, performs a hard delete. Otherwise, soft delete.
      responses:
        '204':
          description: Cluster and contents deleted successfully.
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
  /v1/graph/stats:
    get:
      summary: Get graph statistics
      responses:
        '200':
          description: Graph statistics for the user.
          content:
            application/json:
              schema:
                $ref: ../schemas/graph-stats.json
              examples:
                default:
                  $ref: '#/components/examples/graphStats200'
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
  /v1/graph/snapshot:
    get:
      summary: Get a full graph snapshot
      responses:
        '200':
          description: A full snapshot of the user's graph.
          content:
            application/json:
              schema:
                $ref: ../schemas/graph-snapshot.json
              examples:
                default:
                  $ref: '#/components/examples/graphSnapshot200'
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
    post:
      summary: Persist a full graph snapshot
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                snapshot:
                  $ref: ../schemas/graph-snapshot.json
              required:
                - snapshot
      responses:
        '204':
          description: Snapshot persisted successfully.
        '400':
          description: Bad Request (validation error).
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
        '401':
          description: Not authenticated.
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
  /v1/sync/pull:
    get:
      summary: Pull changes from server
      description: Retrieves changes (conversations, messages, notes, folders) that occurred after the specified `since` timestamp.
      parameters:
        - in: query
          name: since
          required: false
          schema: { type: string, format: date-time }
          description: ISO 8601 timestamp. If omitted, returns all data.
      responses:
        '200':
          description: Sync data
          content:
            application/json:
              schema: { $ref: '../schemas/sync-pull-response.json' }
        '400':
          description: Bad Request
          content:
            application/problem+json:
              schema: { $ref: '../schemas/problem.json' }
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema: { $ref: '../schemas/problem.json' }
  /v1/sync/push:
    post:
      summary: Push changes to server
      description: Applies client-side changes (creates/updates/deletes) to the server. Uses Last-Write-Wins (LWW) based on `updatedAt`.
      parameters:
        - in: header
          name: Idempotency-Key
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '../schemas/sync-push-request.json' }
      responses:
        '200':
          description: Push successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
        '400':
          description: Bad Request
          content:
            application/problem+json:
              schema: { $ref: '../schemas/problem.json' }
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema: { $ref: '../schemas/problem.json' }
        '502':
          description: Upstream error (Database failure)
          content:
            application/problem+json:
              schema: { $ref: '../schemas/problem.json' }
  /v1/notes:
    post:
      summary: Create a note
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                id: { type: string, format: uuid }
                title: { type: string }
                content: { type: string }
                folderId: { type: string, format: uuid }
              required: [title, content]
      responses:
        '201':
          description: Note created
          content:
            application/json:
              schema:
                $ref: ../schemas/note.json
              examples:
                default:
                  $ref: '#/components/examples/noteCreate201'
        '400':
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
    get:
      summary: List notes
      parameters:
        - in: query
          name: folderId
          schema: { type: string, format: uuid }
          description: Filter by folder ID
      responses:
        '200':
          description: List of notes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: ../schemas/note.json
              examples:
                default:
                  $ref: '#/components/examples/noteList200'
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
    delete:
      summary: Delete all notes
      description: Deletes all notes for the authenticated user.
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  deletedCount:
                    type: integer
  /v1/notes/{id}:
    get:
      summary: Get a note
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: Note details
          content:
            application/json:
              schema:
                $ref: ../schemas/note.json
        '404':
          description: Note not found
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
    patch:
      summary: Update a note
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title: { type: string }
                content: { type: string }
                folderId: { type: string, format: uuid }
      responses:
        '200':
          description: Note updated
          content:
            application/json:
              schema:
                $ref: ../schemas/note.json
        '404':
          description: Note not found
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
    delete:
      summary: Delete a note
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
        - in: query
          name: permanent
          schema: { type: boolean, default: false }
          description: If true, performs a hard delete. Otherwise, soft delete.
      responses:
        '204':
          description: Note deleted
        '404':
          description: Note not found
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
  /v1/notes/{id}/restore:
    post:
      summary: Restore a deleted note
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '204':
          description: Note restored
        '404':
          description: Note not found
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
  /v1/folders:
    post:
      summary: Create a folder
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                id: { type: string, format: uuid }
                name: { type: string }
                parentId: { type: string, format: uuid }
              required: [name]
      responses:
        '201':
          description: Folder created
          content:
            application/json:
              schema:
                $ref: ../schemas/folder.json
              examples:
                default:
                  $ref: '#/components/examples/folderCreate201'
        '400':
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
    get:
      summary: List folders
      parameters:
        - in: query
          name: parentId
          schema: { type: string, format: uuid }
          description: Filter by parent folder ID
      responses:
        '200':
          description: List of folders
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: ../schemas/folder.json
              examples:
                default:
                  $ref: '#/components/examples/folderList200'
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
    delete:
      summary: Delete all folders
      description: Deletes all folders and their contents (notes) for the authenticated user.
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  deletedCount:
                    type: integer
  /v1/folders/{id}:
    get:
      summary: Get a folder
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: Folder details
          content:
            application/json:
              schema:
                $ref: ../schemas/folder.json
        '404':
          description: Folder not found
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
    patch:
      summary: Update a folder
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
                parentId: { type: string, format: uuid }
      responses:
        '200':
          description: Folder updated
          content:
            application/json:
              schema:
                $ref: ../schemas/folder.json
        '404':
          description: Folder not found
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
        '401':
          description: Not authenticated
    delete:
      summary: Delete a folder
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
        - in: query
          name: permanent
          schema: { type: boolean, default: false }
          description: If true, performs a hard delete. Otherwise, soft delete.
      responses:
        '204':
          description: Folder deleted
        '404':
          description: Folder not found
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
  /v1/folders/{id}/restore:
    post:
      summary: Restore a deleted folder
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '204':
          description: Folder restored
        '404':
          description: Folder not found
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
  /v1/agent/chat/stream:
    post:
      summary: Stream agent chat
      description: Interactive chat with the AI agent, supporting multiple modes (chat, summary, note). Returns a Server-Sent Events (SSE) stream.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [userMessage]
              properties:
                userMessage: { type: string }
                contextText: { type: string }
                modeHint: { type: string, enum: [chat, summary, note, auto] }
      responses:
        '200':
          description: SSE stream established
          content:
            text/event-stream:
              schema:
                type: string
                example: |
                  event: status
                  data: {"phase":"analyzing","message":"..."}
                  
                  event: chunk
                  data: {"text":"Hello"}
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema: { $ref: '../schemas/problem.json' }
  /v1/graph-ai/generate:
    post:
      summary: Generate graph from text (Async)
      description: Starts an asynchronous background task to generate a graph from the user's conversation history. Returns a task ID.
      requestBody:
        description: Options for graph generation.
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                includeSummary:
                  type: boolean
                  description: Whether to also generate a graph summary (3-mode pipeline).
      responses:
        '202':
          description: Task accepted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  taskId: { type: string }
                  status: { type: string }
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema: { $ref: '../schemas/problem.json' }
        '409':
          description: Conflict (Task already processing)
          content:
            application/problem+json:
              schema: { $ref: '../schemas/problem.json' }
  /v1/graph-ai/summary:
    post:
      summary: Request graph summary generation
      description: Starts an asynchronous background task to generate a summary of the user's graph.
      responses:
        '202':
          description: Task accepted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  taskId: { type: string }
                  status: { type: string }
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema: { $ref: '../schemas/problem.json' }
        '409':
          description: Conflict (Task already processing)
          content:
            application/problem+json:
              schema: { $ref: '../schemas/problem.json' }
    get:
      summary: Get graph summary
      description: Retrieves the generated summary and insights for the user's graph.
      responses:
        '200':
          description: Graph summary
          content:
            application/json:
              schema:
                $ref: ../schemas/graph-summary.json
        '404':
          description: Summary not found
          content:
            application/problem+json:
              schema: { $ref: '../schemas/problem.json' }
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema: { $ref: '../schemas/problem.json' }
    delete:
      summary: Delete graph summary
      description: Deletes the graph summary for the user.
      parameters:
        - in: query
          name: permanent
          schema: { type: boolean, default: false }
          description: If true, performs a hard delete. Otherwise, soft delete.
      responses:
        '204':
          description: No Content (Successfully deleted)
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema: { $ref: '../schemas/problem.json' }
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema: { $ref: '../schemas/problem.json' }
  /v1/graph-ai/summary/restore:
    post:
      summary: Restore graph summary
      description: Restores a soft-deleted graph summary for the user.
      responses:
        '204':
          description: No Content (Successfully restored)
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema: { $ref: '../schemas/problem.json' }
  /v1/graph-ai:
    delete:
      summary: Delete all graph data
      description: Deletes all knowledge graph data (nodes, edges, clusters, subclusters, stats) for the user.
      parameters:
        - in: query
          name: permanent
          schema: { type: boolean, default: false }
          description: If true, performs a hard delete. Otherwise, soft delete.
      responses:
        '204':
          description: No Content (Successfully deleted)
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema: { $ref: '../schemas/problem.json' }
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema: { $ref: '../schemas/problem.json' }
  /v1/graph-ai/restore:
    post:
      summary: Restore all graph data
      description: Restores all soft-deleted knowledge graph data for the user.
      responses:
        '204':
          description: No Content (Successfully restored)
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema: { $ref: '../schemas/problem.json' }
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema: { $ref: '../schemas/problem.json' }
  /v1/graph-ai/add-node:
    post:
      summary: Add updated conversation nodes to graph (Batch)
      description: Queues a process to batch add conversations modified since the graph's last updated time.
      responses:
        '202':
          description: Add node batch queued
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  taskId: { type: string }
                  status: { type: string }
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema: { $ref: '../schemas/problem.json' }


components:
  schemas:
    Problem:
      $ref: ../schemas/problem.json
    Conversation:
      $ref: ../schemas/conversation.json
    Message:
      $ref: ../schemas/message.json
    GraphNode:
      $ref: ../schemas/graph-node.json
    GraphEdge:
      $ref: ../schemas/graph-edge.json
    GraphCluster:
      $ref: ../schemas/graph-cluster.json
    GraphStats:
      $ref: ../schemas/graph-stats.json
    GraphSnapshot:
      $ref: ../schemas/graph-snapshot.json
    Note:
      $ref: ../schemas/note.json
    Folder:
      $ref: ../schemas/folder.json
  examples:
    meGet200:
      externalValue: ./examples/me-get-200.json
    healthOk:
      externalValue: ./examples/health-ok.json
    problem404:
      externalValue: ./examples/problem-404.json
    oauthLoginOk:
      externalValue: ./examples/oauth-login-ok.json
    problem400:
      externalValue: ./examples/problem-400.json
    problem502:
      externalValue: ./examples/problem-502.json
    me401:
      externalValue: ./examples/me-get-401.json
    graphNodeCreate201:
      externalValue: ./examples/graph-node-create-201.json
    graphNodeList200:
      externalValue: ./examples/graph-node-list-200.json
    graphEdgeCreate201:
      externalValue: ./examples/graph-edge-create-201.json
    graphEdgeList200:
      externalValue: ./examples/graph-edge-list-200.json
    graphClusterCreate201:
      externalValue: ./examples/graph-cluster-create-201.json
    graphClusterList200:
      externalValue: ./examples/graph-cluster-list-200.json
    graphStats200:
      externalValue: ./examples/graph-stats-200.json
    graphSnapshot200:
      externalValue: ./examples/graph-snapshot-200.json
    noteCreate201:
      externalValue: ./examples/note-create-201.json
    noteList200:
      externalValue: ./examples/note-list-200.json
    folderCreate201:
      externalValue: ./examples/folder-create-201.json
    folderList200:
      externalValue: ./examples/folder-list-200.json
