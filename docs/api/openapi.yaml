openapi: 3.1.0
info:
  title: GraphNode API
  version: 0.1.0
  description: >-
    Backend API for GraphNode. Errors follow RFC 9457 Problem Details.
jsonSchemaDialect: https://json-schema.org/draft/2020-12/schema
paths:
  /healthz:
    get:
      summary: Health check
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                required: [ok]
              example:
                $ref: './examples/health-ok.json'
        '404':
          description: Not Found
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
              example:
                $ref: './examples/problem-404.json'
  /v1/healthz:
    get:
      summary: Health check (versioned)
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                required: [ok]
              example:
                $ref: './examples/health-ok.json'
        '404':
          description: Not Found
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
              example:
                $ref: './examples/problem-404.json'
  /auth/google/start:
    get:
      summary: Start Google OAuth (redirects)
      description: Initiates Google OAuth2 authorization with state and PKCE. Redirects to Google's consent screen.
      responses:
        '302':
          description: Redirects to Google authorization URL
  /auth/google/callback:
    get:
      summary: Google OAuth callback
      description: Handles Google OAuth2 authorization code exchange. On success, sets a session cookie and returns ok.
      parameters:
        - in: query
          name: code
          required: true
          schema:
            type: string
        - in: query
          name: state
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Login succeeded, session cookie set
          headers:
            Set-Cookie:
              description: Session cookie set by server
              schema:
                type: string
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                required: [ok]
              example:
                $ref: './examples/oauth-login-ok.json'
        '400':
          description: Bad Request (missing/invalid parameters or state mismatch)
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
              example:
                $ref: './examples/problem-400.json'
        '502':
          description: Upstream error (provider failure)
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
              example:
                $ref: './examples/problem-502.json'
  /v1/me:
    get:
      summary: Check login status
      description: Returns current user if session cookie (server session) exists.
      responses:
        '200':
          description: Authenticated
          content:
            application/json:
              schema:
                $ref: ../schemas/me-response.json
              example:
                $ref: './examples/me-get-200.json'
        '401':
          description: Not authenticated
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
              example:
                $ref: './examples/me-get-401.json'
  /v1/ai/conversations:
    post:
      summary: Create conversation
      description: Creates a new conversation using client-provided UUID/ULID as id. Optionally accepts initial messages.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id, title]
              properties:
                id: { type: string }
                title: { type: string }
                messages:
                  type: array
                  items: { $ref: ../schemas/message.json }
            examples:
              default:
                externalValue: ./examples/ai-conversation-create-request.json
      responses:
        '201':
          description: Created
          headers:
            Location:
              description: Resource URL of the created conversation
              schema: { type: string }
          content:
            application/json:
              schema: { $ref: ../schemas/conversation.json }
              examples:
                default:
                  externalValue: ./examples/ai-conversation-create-201.json
        '400':
          description: Bad Request
          content:
            application/problem+json:
              schema: { $ref: ../schemas/problem.json }
    get:
      summary: List conversations
      parameters:
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 100, default: 50 }
        - in: query
          name: cursor
          schema: { type: string, description: ISO 8601 cursor }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: ../schemas/conversation.json }
                  nextCursor:
                    oneOf:
                      - { type: string }
                      - { type: 'null' }
              examples:
                default:
                  externalValue: ./examples/ai-conversation-list-200.json
  /v1/ai/conversations/{conversationId}:
    get:
      summary: Get conversation
      parameters:
        - in: path
          name: conversationId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: ../schemas/conversation.json }
              examples:
                default:
                  externalValue: ./examples/ai-conversation-get-200.json
        '404':
          description: Not Found
          content:
            application/problem+json:
              schema: { $ref: ../schemas/problem.json }
    patch:
      summary: Update conversation
      parameters:
        - in: path
          name: conversationId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title: { type: string }
            examples:
              default:
                externalValue: ./examples/ai-conversation-update-request.json
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: ../schemas/conversation.json }
              examples:
                default:
                  externalValue: ./examples/ai-conversation-update-200.json
    delete:
      summary: Delete conversation
      parameters:
        - in: path
          name: conversationId
          required: true
          schema: { type: string }
      responses:
        '204':
          description: No Content
  /v1/ai/conversations/{conversationId}/messages:
    post:
      summary: Create message
      parameters:
        - in: path
          name: conversationId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: ../schemas/message.json
            examples:
              default:
                externalValue: ./examples/ai-message-create-request.json
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema: { $ref: ../schemas/message.json }
              examples:
                default:
                  externalValue: ./examples/ai-message-create-201.json
  /v1/ai/conversations/{conversationId}/messages/{messageId}:
    patch:
      summary: Update message
      parameters:
        - in: path
          name: conversationId
          required: true
          schema: { type: string }
        - in: path
          name: messageId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                role: { type: string, enum: [user, assistant, system] }
                content: { type: string }
            examples:
              default:
                externalValue: ./examples/ai-message-update-request.json
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: ../schemas/message.json }
              examples:
                default:
                  externalValue: ./examples/ai-message-update-200.json
    delete:
      summary: Delete message
      parameters:
        - in: path
          name: conversationId
          required: true
          schema: { type: string }
        - in: path
          name: messageId
          required: true
          schema: { type: string }
      responses:
        '204':
          description: No Content
  /auth/logout:
    post:
      summary: Logout and destroy session
      responses:
        '204':
          description: Session destroyed
          headers:
            Set-Cookie:
              description: Session cookie cleared (Max-Age=0)
              schema:
                type: string
        '401':
          description: Not authenticated (if already logged out, implementation may still return 204)
          content:
            application/problem+json:
              schema:
                $ref: ../schemas/problem.json
components:
  schemas:
    Problem:
      $ref: ../schemas/problem.json
    Conversation:
      $ref: ../schemas/conversation.json
    Message:
      $ref: ../schemas/message.json
  examples:
    meGet200:
      externalValue: ./examples/me-get-200.json
    healthOk:
      externalValue: ./examples/health-ok.json
    problem404:
      externalValue: ./examples/problem-404.json
    oauthLoginOk:
      externalValue: ./examples/oauth-login-ok.json
    problem400:
      externalValue: ./examples/problem-400.json
    problem502:
      externalValue: ./examples/problem-502.json
    me401:
      externalValue: ./examples/me-get-401.json